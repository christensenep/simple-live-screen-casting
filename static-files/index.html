<!DOCTYPE html>
<meta charset="utf-8">
<meta name="author" content="Atul Varma">
<title>index</title>
<!-- Date: 2011-01-25 -->
<p>html5 is cool.</p>
<style>
a.movie-id {
  display: block;
}

</style>
<script src="socket.io/socket.io.js"></script> 
<script> 
function onSocketError(e) {
  if (window.console) {
    console.error(e);
  } else {
    var error = document.createElement("div");
    error.className = "error";
    error.textContent = e.toString();
    document.body.appendChild(error);
  }
}

function makeErrorTrapper(cb) {
  return function(data) {
    try {
      return cb(data);
    } catch (e) {
      onSocketError(e);
    }
  }
}

function makeMovieBuilder(cb) {
  var states = {
    WAITING_FOR_START: 0,
    WAITING_FOR_END: 1
  };

  var movieID;  
  var state;
  var chunks;
  
  function endMovieAndStartNew(firstChunkOfNewMovie, newMovieID) {
    var allChunks = chunks.join('');
    //console.log("------------- got a movie of size", allChunks.length);
    var dataURL = 'data:video/ogg;base64,' + btoa(allChunks);
    var thisMovieID = movieID;
    startNewMovie(firstChunkOfNewMovie, newMovieID);
    cb(dataURL, thisMovieID);
  }

  function startNewMovie(firstChunk, newMovieID) {
    movieID = newMovieID;
    chunks = [];
    if (firstChunk) {
      chunks.push(firstChunk);
      state = states.WAITING_FOR_END;
    } else
      state = states.WAITING_FOR_START;
  }

  startNewMovie();
  
  return function buildMovie(packet) {
    switch (state) {
    case states.WAITING_FOR_START:
      if (packet.kind == "start") {
        state = states.WAITING_FOR_END;
        movieID = packet.movieID;
        chunks.push(packet.contents);
      }
      break;
    case states.WAITING_FOR_END:
      if (packet.kind == "end") {
        if (packet.movieID != movieID)
          throw new Error("assertion failure, movieID mismatch");
        chunks.push(packet.contents);
        endMovieAndStartNew();
      } else if (packet.kind == "start") {
        endMovieAndStartNew(packet.contents, packet.movieID);
      } else {
        if (packet.movieID != movieID)
          throw new Error("assertion failure, movieID mismatch");
        chunks.push(packet.contents);
      }
      break;
    }
  }
}

function makePacketBuilder(cb) {
  var states = {
    WAITING_FOR_START: 0,
    WAITING_FOR_END: 1
  }
  var cmds = {
    START: "k",
    CHUNK: "c",
    END: "e"
  }

  var state;
  var packet;
  var chunks;

  function startNewPacket() {
    state = states.WAITING_FOR_START;
    chunks = [];
    packet = {
      kind: null,
      contents: null,
      movieID: null
    };
  }

  startNewPacket();

  return function buildPacket(contents) {
    var cmd = contents[0];
    var payload = contents.slice(1);
    switch (state) {
    case states.WAITING_FOR_START:
      if (cmd == cmds.START) {
         packet.kind = payload;
         state = states.WAITING_FOR_END;
      }
      break;
    case states.WAITING_FOR_END:
      if (cmd == cmds.CHUNK) {
        chunks.push(atob(payload));
      } else if (cmd == cmds.END) {
        packet.contents = chunks.join('');
        packet.movieID = parseInt(payload);
        //console.log("got a packet of size", packet.contents.length);
        var packetToProcess = packet;
        startNewPacket();
        cb(packetToProcess);
      }
      break;
    }
  };
}

var container;
var deadVideo = null;
var nextVideo = null;

onload = function() {
  container = document.getElementById("video");
  var socket = new io.Socket(); 
  socket.connect();
  socket.on('connect', function(){
    //console.log("CONNECT");
  });
  socket.on('message', makeErrorTrapper(makePacketBuilder(makeMovieBuilder(function(dataURL, id) {
    var link = document.createElement("a");
    link.className = "movie-id";
    link.setAttribute("href", dataURL);
    link.appendChild(document.createTextNode("Movie #" + id));
    document.body.appendChild(link);
    try {
      //console.log("got a movie");
      var video = document.createElement("video");
      video.setAttribute("src", dataURL);
      //video.setAttribute("controls", "controls");
      //video.setAttribute("autoplay", "autoplay");
      /*video.addEventListener("canplaythrough", function() {
        if (this.style.display == "inline")
          this.play();
        console.log("can play through", this);
      }, false);*/
      video.addEventListener("ended", function() {
        //
        if (nextVideo) {
          container.removeChild(video);
          nextVideo.style.display = "inline";
          nextVideo.play();
          nextVideo = null;
        } else
          deadVideo = video;
        //console.log("END");
      }, false);
      container.appendChild(video);
    } catch (e) {
      if (window.console)
        console.error("WTF", e);
    }
    if (container.children.length > 1 && !deadVideo) {
      video.style.display = "none";
      nextVideo = video;
    } else {
      if (deadVideo) {
        container.removeChild(deadVideo);
        deadVideo = null;
      }
      video.style.display = "inline";
      video.play();
    }
  }))));
  socket.on('disconnect', function(){
    //console.log("DISCONNECT");
  });
};
</script>
<p id="video"></p>
