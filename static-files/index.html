<!DOCTYPE html>
<meta charset="utf-8">
<meta name="author" content="Atul Varma">
<title>index</title>
<!-- Date: 2011-01-25 -->
<p>html5 is cool.</p>
<style>
a.movie-id {
  display: block;
}
</style>
<script src="socket.io/socket.io.js"></script> 
<script> 
function onSocketError(e) {
  if (window.console) {
    console.error(e);
  } else {
    var error = document.createElement("div");
    error.className = "error";
    error.textContent = e.toString();
    document.body.appendChild(error);
  }
}

function makeErrorTrapper(cb) {
  return function(data) {
    try {
      return cb(data);
    } catch (e) {
      onSocketError(e);
    }
  }
}

var container;
var currVideo = null;
var nextVideo = null;

function videoURL(movieID) {
  return '/movie/' + movieID + '.ogg';
}

function makeCurrVideo(movieID) {
  console.log('makeCurrVideo(' + movieID + ')');
  currVideo = movieID;
  var video = document.createElement("video");
  video.setAttribute("src", videoURL(movieID));
  video.addEventListener("canplaythrough", function() {
    console.log("movie", movieID, "can play through. playing it!");
    video.play();
    video.addEventListener("ended", function() {
      container.removeChild(video);
      currVideo = null;
      if (nextVideo) {
        makeCurrVideo(nextVideo);
        nextVideo = null;
      }
    }, false);
  }, false);
  container.appendChild(video);
  video.load();
}

onload = function() {
  container = document.getElementById("video");
  var socket = new io.Socket(); 
  socket.connect();
  socket.on('connect', function(){
    //console.log("CONNECT");
  });
  socket.on('message', makeErrorTrapper(function(movieID) {
    movieID = parseInt(movieID);
    console.log(movieID);
    var link = document.createElement("a");
    link.className = "movie-id";
    link.setAttribute("href", videoURL(movieID));
    link.appendChild(document.createTextNode("Movie #" + movieID));
    document.body.appendChild(link);
    if (currVideo)
      nextVideo = movieID;
    else
      makeCurrVideo(movieID);
  }));
  socket.on('disconnect', function(){
    //console.log("DISCONNECT");
  });
};
</script>
<p id="video"></p>
