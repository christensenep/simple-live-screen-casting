<!DOCTYPE html>
<meta charset="utf-8">
<meta name="author" content="Atul Varma">
<title>index</title>
<!-- Date: 2011-01-25 -->
<p>html5 is cool.</p>
<style>
a.movie-id {
  display: block;
}
</style>
<script src="socket.io/socket.io.js"></script> 
<script> 
function onSocketError(e) {
  if (window.console) {
    console.error(e);
  } else {
    var error = document.createElement("div");
    error.className = "error";
    error.textContent = e.toString();
    document.body.appendChild(error);
  }
}

function makeErrorTrapper(cb) {
  return function(data) {
    try {
      return cb(data);
    } catch (e) {
      onSocketError(e);
    }
  }
}

var gVideoContainer,
    gCurrentlyLoadingVideo,
    gCurrentlyPlayingVideo,
    gCurrentlyEndedVideo,
    gReadyToPlayVideo,
    gLatestMovieInfo;

function videoURL(movieID) {
  return '/movie/' + movieID + '.ogg';
}

function startLoadingVideo(movieInfo) {
  if (gCurrentlyLoadingVideo)
    throw new Error("Assertion failure, a video is already being loaded!");
  var video = document.createElement("video");
  video.setAttribute("src", videoURL(movieInfo.id));
  video.setAttribute("preload", "auto");
  video.setAttribute("id", movieInfo.id.toString());
  gVideoContainer.appendChild(video);
  video.addEventListener("progress", function isBuffered() {
    if (video.buffered.length == 1 &&
        video.buffered.end(0) == movieInfo.duration) {
      video.removeEventListener("progress", isBuffered, false);
      gCurrentlyLoadingVideo = null;
      onNetworkIdle();
      onVideoReadyToPlay(video);
    }
  }, false);
  video.addEventListener("ended", function() {
    onVideoEnded(video);
  }, false);
  video.style.display = "none";
  video.load();
  gCurrentlyLoadingVideo = video;
}

function onVideoEnded(video) {
  if (gCurrentlyEndedVideo)
    throw new Error("Assertion failure, a video is already ended!");
  gCurrentlyPlayingVideo = null;
  gCurrentlyEndedVideo = video;
  if (gReadyToPlayVideo) {
    onVideoReadyToPlay(gReadyToPlayVideo);
    gReadyToPlayVideo = null;
  }
}

function onVideoReadyToPlay(video) {
  if (gCurrentlyPlayingVideo) {
    if (gReadyToPlayVideo) {
      gVideoContainer.removeChild(gReadyToPlayVideo);
    }
    gReadyToPlayVideo = video;
  } else {
    video.style.display = "inline";
    video.play();
    if (gCurrentlyEndedVideo) {
      gVideoContainer.removeChild(gCurrentlyEndedVideo);
      gCurrentlyEndedVideo = null;
    }
    gCurrentlyPlayingVideo = video;
  }
}

function onNetworkIdle() {
  if (gLatestMovieInfo) {
    startLoadingVideo(gLatestMovieInfo);
    gLatestMovieInfo = null;
  }
}

onload = function() {
  gVideoContainer = document.getElementById("video");
  var socket = new io.Socket(); 
  socket.connect();
  socket.on('connect', function(){});
  socket.on('message', makeErrorTrapper(function(message) {
    var items = message.split(' ');
    gLatestMovieInfo = {
      id: parseInt(items[0]),
      duration: parseInt(items[1])
    };
    if (!gCurrentlyLoadingVideo)
      onNetworkIdle();
  }));
  socket.on('disconnect', function(){});
};
</script>
<p id="video"></p>
